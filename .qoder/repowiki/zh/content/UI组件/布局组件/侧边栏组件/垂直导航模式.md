# 垂直导航模式

<cite>
**本文档引用文件**  
- [NavVertical.vue](file://web/src/layout/components/lay-sidebar/NavVertical.vue)
- [SidebarItem.vue](file://web/src/layout/components/lay-sidebar/components/SidebarItem.vue)
- [SidebarLogo.vue](file://web/src/layout/components/lay-sidebar/components/SidebarLogo.vue)
- [app.ts](file://web/src/store/modules/app.ts)
- [permission.ts](file://web/src/store/modules/permission.ts)
- [useNav.ts](file://web/src/layout/hooks/useNav.ts)
- [types.ts](file://web/src/layout/types.ts)
- [router/utils.ts](file://web/src/router/utils.ts)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
垂直导航模式是Vue Pure Admin管理系统中的核心布局组件之一，主要用于侧边栏菜单的展示与交互。该模式通过`NavVertical.vue`组件实现，支持多级菜单递归渲染、权限控制、国际化及响应式适配。它与`SidebarItem`、`SidebarLogo`等子组件协同工作，构成完整的侧边栏导航体系。本文档将深入解析其内部实现机制、使用场景及最佳实践。

## 项目结构
垂直导航相关组件位于`web/src/layout/components/lay-sidebar/`目录下，采用模块化设计，各组件职责清晰，便于维护和扩展。

```mermaid
graph TB
subgraph "侧边栏组件"
NavVertical[NavVertical.vue]
SidebarItem[SidebarItem.vue]
SidebarLogo[SidebarLogo.vue]
SidebarLeftCollapse[SidebarLeftCollapse.vue]
SidebarCenterCollapse[SidebarCenterCollapse.vue]
end
subgraph "状态管理"
appStore[app.ts]
permissionStore[permission.ts]
end
subgraph "工具与钩子"
useNav[useNav.ts]
routerUtils[router/utils.ts]
types[types.ts]
end
NavVertical --> SidebarItem
NavVertical --> SidebarLogo
NavVertical --> SidebarLeftCollapse
NavVertical --> SidebarCenterCollapse
NavVertical --> appStore
NavVertical --> permissionStore
NavVertical --> useNav
SidebarItem --> types
useNav --> appStore
useNav --> permissionStore
useNav --> routerUtils
```

**图示来源**  
- [NavVertical.vue](file://web/src/layout/components/lay-sidebar/NavVertical.vue)
- [SidebarItem.vue](file://web/src/layout/components/lay-sidebar/components/SidebarItem.vue)
- [SidebarLogo.vue](file://web/src/layout/components/lay-sidebar/components/SidebarLogo.vue)
- [app.ts](file://web/src/store/modules/app.ts)
- [permission.ts](file://web/src/store/modules/permission.ts)
- [useNav.ts](file://web/src/layout/hooks/useNav.ts)
- [types.ts](file://web/src/layout/types.ts)
- [router/utils.ts](file://web/src/router/utils.ts)

**本节来源**  
- [web/src/layout/components/lay-sidebar/](file://web/src/layout/components/lay-sidebar/)

## 核心组件
垂直导航模式的核心由`NavVertical.vue`驱动，它负责整合菜单数据、控制显示逻辑，并与应用状态(store)进行交互。`SidebarItem.vue`实现菜单项的递归渲染，支持单个菜单和子菜单的差异化展示。`SidebarLogo.vue`则负责顶部Logo区域的显示与跳转逻辑。这些组件共同构成了一个功能完整、交互流畅的侧边栏导航系统。

**本节来源**  
- [NavVertical.vue](file://web/src/layout/components/lay-sidebar/NavVertical.vue#L1-L137)
- [SidebarItem.vue](file://web/src/layout/components/lay-sidebar/components/SidebarItem.vue#L1-L230)
- [SidebarLogo.vue](file://web/src/layout/components/lay-sidebar/components/SidebarLogo.vue#L1-L73)

## 架构概述
垂直导航的架构设计遵循了清晰的分层原则，将UI展示、状态管理、路由逻辑和权限控制分离。

```mermaid
graph TD
A[用户界面] --> B[NavVertical.vue]
B --> C[useNav 钩子]
C --> D[app Store]
C --> E[permission Store]
B --> F[SidebarItem.vue]
F --> G[递归渲染]
B --> H[SidebarLogo.vue]
D --> I[sidebar.opened 状态]
E --> J[wholeMenus 菜单数据]
C --> K[router/utils.ts]
K --> L[权限过滤]
K --> M[路径查找]
```

**图示来源**  
- [NavVertical.vue](file://web/src/layout/components/lay-sidebar/NavVertical.vue#L1-L137)
- [useNav.ts](file://web/src/layout/hooks/useNav.ts#L22-L179)
- [app.ts](file://web/src/store/modules/app.ts#L1-L91)
- [permission.ts](file://web/src/store/modules/permission.ts#L1-L75)
- [router/utils.ts](file://web/src/router/utils.ts#L1-L416)

## 详细组件分析

### NavVertical.vue 分析
`NavVertical.vue`是垂直导航的主容器组件，负责协调子组件并管理整体状态。

#### 组件交互关系
```mermaid
classDiagram
class NavVertical {
+isShow : boolean
+showLogo : boolean
+menuData : ComputedRef
+loading : ComputedRef
+defaultActive : ComputedRef
+getSubMenuData() : void
+onMounted() : void
+onBeforeUnmount() : void
}
class SidebarLogo {
+collapse : boolean
+title : ComputedRef
+getLogo() : string
}
class SidebarItem {
+item : menuType
+isNest : boolean
+basePath : string
+onlyOneChild : menuType
+hasOneShowingChild() : boolean
+resolvePath() : string
}
class SidebarLeftCollapse {
+is-active : boolean
+toggleClick : Event
}
class SidebarCenterCollapse {
+is-active : boolean
+toggleClick : Event
}
NavVertical --> SidebarLogo : "v-if=showLogo"
NavVertical --> SidebarItem : "v-for in menuData"
NavVertical --> SidebarLeftCollapse : "v-if=device!=mobile"
NavVertical --> SidebarCenterCollapse : "v-if=device!=mobile"
NavVertical ..> useNav : "useNav()"
NavVertical ..> permissionStore : "usePermissionStoreHook()"
NavVertical ..> router : "useRoute()"
```

**图示来源**  
- [NavVertical.vue](file://web/src/layout/components/lay-sidebar/NavVertical.vue#L1-L137)
- [SidebarLogo.vue](file://web/src/layout/components/lay-sidebar/components/SidebarLogo.vue#L1-L73)
- [SidebarItem.vue](file://web/src/layout/components/lay-sidebar/components/SidebarItem.vue#L1-L230)

#### 菜单渲染与状态管理流程
```mermaid
sequenceDiagram
participant User as 用户
participant NavVertical as NavVertical.vue
participant UseNav as useNav.ts
participant AppStore as app.ts
participant PermissionStore as permission.ts
participant Router as Vue Router
User->>NavVertical : 页面加载/路由变化
NavVertical->>Router : 获取当前路由(useRoute)
NavVertical->>UseNav : 调用useNav()获取状态
UseNav->>AppStore : 获取sidebar.opened状态
UseNav->>PermissionStore : 获取wholeMenus数据
NavVertical->>PermissionStore : 计算menuData
NavVertical->>NavVertical : 计算defaultActive激活项
NavVertical->>NavVertical : 执行getSubMenuData()
NavVertical->>router/utils.ts : getParentPaths()
NavVertical->>router/utils.ts : findRouteByPath()
router/utils.ts-->>NavVertical : 返回子菜单数据
NavVertical->>SidebarItem : 渲染菜单项
SidebarItem->>SidebarItem : hasOneShowingChild()判断
alt 单个菜单项
SidebarItem->>SidebarLinkItem : 渲染链接
else 有子菜单
SidebarItem->>el-sub-menu : 渲染子菜单
SidebarItem->>SidebarItem : 递归调用
end
NavVertical->>SidebarLogo : 根据showLogo显示Logo
```

**图示来源**  
- [NavVertical.vue](file://web/src/layout/components/lay-sidebar/NavVertical.vue#L1-L137)
- [useNav.ts](file://web/src/layout/hooks/useNav.ts#L22-L179)
- [app.ts](file://web/src/store/modules/app.ts#L1-L91)
- [permission.ts](file://web/src/store/modules/permission.ts#L1-L75)
- [router/utils.ts](file://web/src/router/utils.ts#L1-L416)

**本节来源**  
- [NavVertical.vue](file://web/src/layout/components/lay-sidebar/NavVertical.vue#L1-L137)
- [useNav.ts](file://web/src/layout/hooks/useNav.ts#L22-L179)
- [app.ts](file://web/src/store/modules/app.ts#L1-L91)
- [permission.ts](file://web/src/store/modules/permission.ts#L1-L75)
- [router/utils.ts](file://web/src/router/utils.ts#L1-L416)

### SidebarItem.vue 分析
`SidebarItem.vue`是菜单项的渲染核心，负责处理单个菜单和多级子菜单的展示逻辑。

#### 菜单层级渲染逻辑
```mermaid
flowchart TD
Start([开始渲染菜单项]) --> HasChildren{"是否有子菜单?"}
HasChildren --> |否| RenderLink["渲染SidebarLinkItem"]
HasChildren --> |是| HasOneChild{"hasOneShowingChild()"}
HasOneChild --> |是| RenderSingle["渲染单个菜单项"]
HasOneChild --> |否| RenderSubMenu["渲染el-sub-menu"]
RenderSingle --> CheckShowParent{"meta.showParent?"}
CheckShowParent --> |是| RenderParent["显示父级菜单"]
CheckShowParent --> |否| RenderChild["显示唯一子菜单"]
RenderSubMenu --> Loop["递归调用SidebarItem渲染子项"]
RenderLink --> End([结束])
RenderParent --> End
RenderChild --> End
Loop --> End
```

**图示来源**  
- [SidebarItem.vue](file://web/src/layout/components/lay-sidebar/components/SidebarItem.vue#L1-L230)

**本节来源**  
- [SidebarItem.vue](file://web/src/layout/components/lay-sidebar/components/SidebarItem.vue#L1-L230)

### SidebarLogo.vue 分析
`SidebarLogo.vue`组件负责顶部Logo区域的展示，其显示状态受应用配置控制。

**本节来源**  
- [SidebarLogo.vue](file://web/src/layout/components/lay-sidebar/components/SidebarLogo.vue#L1-L73)

## 依赖分析
垂直导航组件依赖于多个核心模块，形成了一个紧密耦合但职责分明的系统。

```mermaid
graph TD
NavVertical --> useNav
NavVertical --> permissionStore
NavVertical --> router
useNav --> appStore
useNav --> permissionStore
useNav --> routerUtils
permissionStore --> treeUtils
permissionStore --> authUtils
routerUtils --> permissionStore
routerUtils --> multiTagsStore
style NavVertical fill:#f9f,stroke:#333
style useNav fill:#bbf,stroke:#333
style appStore fill:#f96,stroke:#333
style permissionStore fill:#f96,stroke:#333
style routerUtils fill:#6f9,stroke:#333
```

**图示来源**  
- [NavVertical.vue](file://web/src/layout/components/lay-sidebar/NavVertical.vue#L1-L137)
- [useNav.ts](file://web/src/layout/hooks/useNav.ts#L22-L179)
- [app.ts](file://web/src/store/modules/app.ts#L1-L91)
- [permission.ts](file://web/src/store/modules/permission.ts#L1-L75)
- [router/utils.ts](file://web/src/router/utils.ts#L1-L416)

**本节来源**  
- [NavVertical.vue](file://web/src/layout/components/lay-sidebar/NavVertical.vue#L1-L137)
- [useNav.ts](file://web/src/layout/hooks/useNav.ts#L22-L179)
- [app.ts](file://web/src/store/modules/app.ts#L1-L91)
- [permission.ts](file://web/src/store/modules/permission.ts#L1-L75)
- [router/utils.ts](file://web/src/router/utils.ts#L1-L416)

## 性能考虑
垂直导航在性能方面做了多项优化：
1. **计算属性缓存**：`menuData`、`loading`、`defaultActive`等使用`computed`，避免重复计算。
2. **防抖与节流**：在`permission.ts`中使用`debounce`函数防止频繁操作。
3. **路由懒加载**：通过`import.meta.glob`实现视图组件的动态导入。
4. **状态持久化**：使用`storageLocal`将侧边栏展开状态保存至localStorage，避免页面刷新后状态丢失。
5. **事件解绑**：在`onBeforeUnmount`中解绑`emitter`事件，防止内存泄漏。

## 故障排除指南
当垂直导航出现问题时，可按以下步骤排查：

**本节来源**  
- [NavVertical.vue](file://web/src/layout/components/lay-sidebar/NavVertical.vue#L1-L137)
- [useNav.ts](file://web/src/layout/hooks/useNav.ts#L22-L179)
- [app.ts](file://web/src/store/modules/app.ts#L1-L91)

## 结论
垂直导航模式通过`NavVertical.vue`组件实现了功能强大且灵活的侧边栏菜单系统。它利用Vue 3的组合式API和Pinia状态管理，实现了响应式的数据绑定和高效的组件通信。通过与`SidebarItem`、`SidebarLogo`等组件的协作，支持多级菜单递归渲染、权限过滤、国际化和响应式布局。其设计充分考虑了性能和可维护性，是Vue Pure Admin项目中不可或缺的核心组件之一。